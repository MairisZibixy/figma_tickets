<!DOCTYPE html>

<link rel="stylesheet" href="style.css" />
<meta charset="utf-8" />
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<div id="app">
    <button @click="requestApi('api.php')">request</button>
    <input type="text" v-model="title" />

    <div class="tickets">
        <div class="tickets__header">
            <h1 v-text="title"></h1>
            <tickets_table>
                <tickets_header>
                    <table_columns v-for="th in ticket_titles" :column="th" :callback="sortArray"></table_columns>
                </tickets_header>
                <tickets_row v-for="ticket in ticket_list" :row="ticket"></tickets_row>
            </tickets_table>
        </div>
    </div>
</div>

<script src="script.js"></script>
<script>
    Vue.component("tickets_table", {
        template: `<table class="tickets__list">
            <slot></slot>
        </table>`,
    });

    Vue.component("tickets_header", {
        template: `
            <tr>
                <slot></slot>
            </tr>
        `,
    });

    Vue.component("table_columns", {
        props: ["column", "callback"],
        template: '<th v-text="column" @click="callback(column)"></th>',
    });

    Vue.component("tickets_row", {
        props: ["row"],
        template: `
        <tr>
            <td>
                <img v-if="row.image_url" v-bind:src="row.image_url">
                <template v-if="!row.image_url">
                    <i>No image</i>
                    <span>üôéüèª‚Äç‚ôÇÔ∏è</span>
                </template>
                
                <span>{{row.details}}</span>
            </td>
            <td>
                {{row.customer_name}}
            </td>
            <td class="date">{{row.date}} <span>{{row.time}}</span></td>
            <td>
                <span :class="'priority priority_' + row.priority">{{row.priority}}</span>
            </td>
        </tr>`,
    });

    let sort_direction = 1,
        last_name = "";

    let app = new Vue({
        el: "#app",
        data: {
            title: "All tickets",
            ticket_titles: ["Ticket details", "Customer name", "Date", "Priority"],
            ticket_list: [],
        },
        methods: {
            requestApi: function(url) {
                request(url, changeList);
            },
            sortArray: function(name) {
                let keys = {
                    "Ticket details": "details",
                    "Customer name": "customer_name",
                    Date: "date",
                    Priority: "priority",
                };

                name = keys[name];
                if (last_name != name) {
                    sort_direction = 1;
                }
                last_name = name;

                this.ticket_list.sort(function(a, b) {
                    var nameA = a[name].toUpperCase(); // ignore upper and lowercase
                    var nameB = b[name].toUpperCase(); // ignore upper and lowercase
                    if (nameA < nameB) {
                        return -1 * sort_direction;
                    }
                    if (nameA > nameB) {
                        return 1 * sort_direction;
                    }
                    return 0;
                });

                sort_direction = sort_direction * -1;
            },
        },
    });

    function changeList(response) {
        app.ticket_list = JSON.parse(response);
    }

    request("api.php", changeList);
</script>